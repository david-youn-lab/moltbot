# 배포 가이드

저비용 프로덕션 배포 방법

## 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    인터넷                                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│              Oracle Cloud Free Tier                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Ubuntu Server (ARM)                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │
│  │  │  FastAPI    │  │  PostgreSQL │  │   Nginx     │ │    │
│  │  │  Server     │  │  (Supabase) │  │  (Reverse)  │ │    │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘ │    │
│  │         │                │                │         │    │
│  │         └────────────────┴────────────────┘         │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                        ▲
                        │
┌───────────────────────┴─────────────────────────────────────┐
│                 소비자 클라이언트                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Windows    │  │   Mac       │  │   Linux     │         │
│  │  앱         │  │   앱        │  │   앱        │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 1. Oracle Cloud Free Tier 설정

### 계정 생성
1. https://www.oracle.com/cloud/free/ 접속
2. "Start for free" 클릭
3. 계정 생성 (신용카드 필요, 청구 없음)

### 인스턴스 생성
1. Compute > Instances > Create Instance
2. 설정:
   - Shape: VM.Standard.A1.Flex (ARM)
   - OCPUs: 4 (무료 한도)
   - Memory: 24GB (무료 한도)
   - OS: Ubuntu 22.04

### 네트워크 설정
1. Virtual Cloud Networks에서 Security List 편집
2. Ingress Rules 추가:
   - Port 80 (HTTP)
   - Port 443 (HTTPS)
   - Port 22 (SSH)

## 2. 서버 설정

### SSH 접속
```bash
ssh -i <private_key> ubuntu@<public_ip>
```

### 기본 패키지 설치
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y python3.11 python3.11-venv python3-pip nginx certbot python3-certbot-nginx
```

### 프로젝트 설치
```bash
# 디렉토리 생성
sudo mkdir -p /opt/voicecontrol
sudo chown ubuntu:ubuntu /opt/voicecontrol

# 코드 복사 (scp 또는 git)
cd /opt/voicecontrol
git clone <repository> .

# 가상환경
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 환경 변수
```bash
cat > /opt/voicecontrol/.env << EOF
SECRET_KEY=$(openssl rand -hex 32)
DATABASE_URL=sqlite:///./voicecontrol.db
DEBUG=false
HOST=0.0.0.0
PORT=8000
EOF
```

### Systemd 서비스
```bash
sudo cat > /etc/systemd/system/voicecontrol.service << EOF
[Unit]
Description=VoiceControl API Server
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/opt/voicecontrol/서버
Environment="PATH=/opt/voicecontrol/venv/bin"
EnvironmentFile=/opt/voicecontrol/.env
ExecStart=/opt/voicecontrol/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable voicecontrol
sudo systemctl start voicecontrol
```

## 3. Nginx 리버스 프록시

```nginx
# /etc/nginx/sites-available/voicecontrol
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/voicecontrol /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 4. HTTPS 설정 (무료)

```bash
sudo certbot --nginx -d your-domain.com
```

## 5. 데이터베이스 옵션

### SQLite (기본, 소규모)
- 설정 없이 바로 사용
- 파일 기반
- 동시 접속 제한

### Supabase (무료, 권장)
1. https://supabase.com 계정 생성
2. 새 프로젝트 생성
3. Connection String 복사
4. .env 수정:
```
DATABASE_URL=postgresql://user:password@host:5432/database
```

## 6. 클라이언트 배포

### PyInstaller
```bash
pip install pyinstaller
cd 클라이언트
pyinstaller --onefile --name voicecontrol trigger.py
```

### 배포 파일
- `dist/voicecontrol.exe` (Windows)
- `dist/voicecontrol` (Linux/Mac)

## 비용 요약

| 서비스 | 비용 |
|--------|------|
| Oracle Cloud 서버 | 무료 (영구) |
| Supabase DB | 무료 (500MB) |
| Let's Encrypt SSL | 무료 |
| 도메인 | $10/년 (선택) |
| **총합** | **$0 ~ $10/년** |

## 모니터링

### 로그 확인
```bash
sudo journalctl -u voicecontrol -f
```

### 상태 확인
```bash
sudo systemctl status voicecontrol
curl http://localhost:8000/health
```

## 백업

### 데이터베이스 백업
```bash
# SQLite
cp /opt/voicecontrol/서버/voicecontrol.db /backup/

# 자동 백업 (cron)
0 3 * * * cp /opt/voicecontrol/서버/voicecontrol.db /backup/voicecontrol_$(date +\%Y\%m\%d).db
```
